# 电商购物车的设计与实现

## 业务分析

- 仅分析 redis 的存储模型

添加、浏览、更改数量、删除、清空

- 购物车与数据库间的持久化同步不讨论时

- 购物车与订单之间的关系不讨论

提交购物车：读取数据生成订单
商家临时调整价格：隶属于订单级别

- 未登录用户购物车信息存储（不讨论）
  cookie 存储

## 解决方案

- 以客户 id 作为 key，每位用户创建一个 hash 存储结构对应购物车信息
- 将商品编号作为 field，购买数量作为 value 进行存储
- 添加商品：追加全新的 field 于 value
- 浏览：遍历 hash
- 更改数量：自增/自减，设置 value 值
- 删除商品：删除 field
- 清空：删除 key
  示例代码如下：

```shell
# 001 用户购买g01商品100件，g02商品200件
hmset 001 g01 100 g02 200
# 002用户购买g02商品1件，g04商品7件
hmset 002 g02 1 g04 7
```

当前仅仅是将数据存储到 redis 中，并没有起到加速作用，商品信息还需要查询数据库。可以使用以下方案解决

- 每条购物车中的商品信息记录保存为两条 field

- field1 专门用于保存数量

命名格式：商品 id:nums
保存数据：数值

- field2 专门用于保存购物车中显示的商品信息，包含文字描述，图片地址，所属商家信息等

命名格式：商品 id:info
保存数据：json

由于 field2 可能在多条商品记录中存在，固 field2 里的数据可保存到独立的 hash。此时，如果每添加一条购物车记录，就保存一次 hash 数据，显然是不合理的，可以通过`hsetnx`操作来保存数据，如果数据存在，则不执行保存操作。

```shell
hsetnx key field value
```
